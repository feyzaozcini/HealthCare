@page "/laborer-backlog"
@using Pusula.Training.HealthCare.LabRequests
@using Pusula.Training.HealthCare.TestProcesses

@inject ITestProcessesAppService TestProcessesAppService
@inject ILabRequestsAppService LabRequestsAppService

<div class="flex-grow-1 d-flex justify-content-center mb-2">
    <SfTextBox Placeholder="Protokol Ara"
               FloatLabelType="FloatLabelType.Never"
               @bind-Value="LabRequestsFilter!.FilterText"
               Width="50%"
               Input="OnInputChange">
    </SfTextBox>
</div>

<div class="d-flex flex-row">
    <SfGrid DataSource="@LabRequestsList" AllowPaging="false" AllowSorting="true" RowHeight="40" Width="100%" Height="750px" AllowResizing="false" GridLines="@GridLine.Both">
        <GridColumns>
            <GridColumn Field=@nameof(LabRequestDto.ProtocolNo) HeaderText="Protokol No" Width="10" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field=@nameof(LabRequestDto.ProtocolStartDate) HeaderText="Protokol Başlangıç Tarihi" Width="20" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn HeaderText="Hasta Adı-Soyadı" Width="25" TextAlign="TextAlign.Center">
                <Template Context="context">
                    @if (context is LabRequestDto labrequest)
                    {
                        <span>@labrequest.PatientName @labrequest.PatientSurname</span>
                    }
                </Template>
            </GridColumn>
            <GridColumn HeaderText="İsteyen Doktor" Width="25" TextAlign="TextAlign.Center">
                <Template Context="context">
                    @if (context is LabRequestDto labrequest)
                    {
                        <span>@labrequest.DoctorName @labrequest.DoctorSurname</span>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field=@nameof(LabRequestDto.Status) HeaderText="Protokol Durumu" Width="25" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn HeaderText="Sonuç Gir" Width="25" TextAlign="TextAlign.Center">
                <Template Context="context">
                    @if (context is LabRequestDto labRequest)
                    {
                        <SfButton CssClass="e-small e-primary" OnClick="(() => OpenResultUpdateModal(labRequest))">Sonuç Gir</SfButton>
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </SfGrid>
</div>

@*Sonuç Gir Dialog*@
<SfDialog @ref="ResultDialog" IsModal="true" ShowCloseIcon="true" Width="600px" Visible="false" Header="Test Sonuçları">
    <DialogTemplates>
        <Content>
            <SfGrid DataSource="@TestProcessesList" AllowPaging="false" AllowSorting="true" RowHeight="40" Width="100%" Height="300px" AllowResizing="false" GridLines="@GridLine.Both">
                <GridColumns>
                    <GridColumn Field=@nameof(TestProcessDto.TestGroupName) HeaderText="Grup" Width="50%"></GridColumn>
                    <GridColumn Field=@nameof(TestProcessDto.TestGroupItemName) HeaderText="Test" Width="50%"></GridColumn>
                    <GridColumn Field=@nameof(TestProcessDto.Result) HeaderText="Sonuç" Width="50%">
                        <Template Context="context">
                            @if (context is TestProcessDto testProcess)
                            {
                                <SfNumericTextBox TValue="decimal?" @bind-Value="testProcess.Result" Placeholder="Sonuç Girin" Min="0"></SfNumericTextBox>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </Content>
        <FooterTemplate>
            <SfButton CssClass="e-small e-success" OnClick="SaveResult">Kaydet</SfButton>
            <SfButton CssClass="e-small e-primary" OnClick="CloseResultDialog">Kapat</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

@* YAPILACAKLAR
   - Business rules eklenecek.
   - Toast ile handle error ve işlem durumları gösterilecek.
   - Sonuç durumu, eğer protokole ait tüm test sonuçları girildiyse tamamlandı olarak işaretlenecek.
   - Tüm süreçleri tamamlanan testler, iş listesinden silinecek. Ayrı bir tab'da "Tamamlanan İşler" olarak görüntülenecek.
*@